rules_version = '2';

// Helper: user can read their own document
function isOwner(uid) {
  return request.auth != null && request.auth.uid == uid;
}

// Users: own profile only for write; any authenticated user can read profile (for profile pages)
match /users/{userId} {
  allow read: if request.auth != null;
  allow create: if request.auth != null && request.auth.uid == userId;
  allow update, delete: if request.auth != null && request.auth.uid == userId;
}

// Bookings: participants only for read; booker creates; provider accept/reject; booker cancel
function isBookingParticipant() {
  return request.auth != null
    && (resource.data.bookerId == request.auth.uid || resource.data.providerId == request.auth.uid);
}
function isProvider() {
  return request.auth != null && resource.data.providerId == request.auth.uid;
}
function isBooker() {
  return request.auth != null && resource.data.bookerId == request.auth.uid;
}
function validBookingCreate() {
  return request.auth != null
    && request.resource.data.bookerId == request.auth.uid
    && request.resource.data.providerRole != 'user'
    && request.resource.data.bookerId != request.resource.data.providerId;
}
function validStatusUpdate() {
  let status = request.resource.data.status;
  // Provider can accept or reject
  if (isProvider() && (status == 'accepted' || status == 'rejected')) { return true; }
  // Booker can cancel
  if (isBooker() && status == 'cancelled') { return true; }
  return false;
}

match /bookings/{bookingId} {
  allow read: if request.auth != null
    && (resource.data.bookerId == request.auth.uid || resource.data.providerId == request.auth.uid);
  allow create: if validBookingCreate();
  allow update: if isBookingParticipant() && validStatusUpdate();
  allow delete: if false;
}
