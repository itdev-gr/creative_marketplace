---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Discover – Creative Marketplace">
  <div class="min-h-screen flex flex-col bg-slate-50">
    <!-- Header: nav filled by client for auth -->
    <header class="border-b border-slate-200/80 bg-white/80 backdrop-blur-sm sticky top-0 z-20">
      <div class="max-w-6xl mx-auto px-4 sm:px-6 h-16 flex items-center justify-between">
        <a href="/" class="text-lg font-semibold text-slate-800 tracking-tight hover:text-violet-600 transition-colors">
          Creative Marketplace
        </a>
        <nav id="discover-header-nav" class="flex items-center gap-3">
          <a href="/register" class="text-sm font-medium text-slate-600 hover:text-slate-900 px-3 py-2 rounded-lg hover:bg-slate-100">Become a seller</a>
          <a href="/login" class="text-sm font-medium text-slate-600 hover:text-slate-900 px-3 py-2 rounded-lg hover:bg-slate-100">Sign in</a>
          <a href="/register" class="text-sm font-semibold text-white bg-violet-600 hover:bg-violet-500 px-4 py-2 rounded-lg">Register</a>
        </nav>
      </div>
    </header>

    <main class="flex-1 max-w-6xl mx-auto w-full px-4 sm:px-6 py-6">
      <!-- Menu tabs (image 2 style) -->
      <nav class="flex items-center gap-8 border-b border-slate-200 pb-0 mb-6" aria-label="Categories">
        <button type="button" data-role-tab="influencer" data-active="true" class="discover-tab pt-4 pb-3 px-1 font-medium text-slate-600 border-b-2 border-transparent hover:text-slate-900 data-[active]:text-slate-900 data-[active]:border-violet-600">
          Influencers
        </button>
        <button type="button" data-role-tab="videographer" class="discover-tab pt-4 pb-3 px-1 font-medium text-slate-600 border-b-2 border-transparent hover:text-slate-900 data-[active]:text-slate-900 data-[active]:border-violet-600">
          Videographers
        </button>
        <button type="button" data-role-tab="editor" class="discover-tab pt-4 pb-3 px-1 font-medium text-slate-600 border-b-2 border-transparent hover:text-slate-900 data-[active]:text-slate-900 data-[active]:border-violet-600">
          Editors
        </button>
        <button type="button" data-role-tab="model" class="discover-tab pt-4 pb-3 px-1 font-medium text-slate-600 border-b-2 border-transparent hover:text-slate-900 data-[active]:text-slate-900 data-[active]:border-violet-600">
          Models
        </button>
      </nav>

      <!-- Search bar (rounded, 3 segments + button) -->
      <div class="flex items-center rounded-full border border-slate-200 bg-white shadow-sm overflow-hidden mb-8">
        <div class="flex-1 flex divide-x divide-slate-200">
          <div class="flex-1 min-w-0 py-3 px-4">
            <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide">What</p>
            <p class="text-sm text-slate-400 truncate" id="search-what">Category</p>
          </div>
          <div class="flex-1 min-w-0 py-3 px-4">
            <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide">When</p>
            <p class="text-sm text-slate-400 truncate" id="search-when">Booking date</p>
          </div>
          <div class="flex-1 min-w-0 py-3 px-4">
            <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide">Sort</p>
            <p class="text-sm text-slate-400 truncate" id="search-sort">Newest</p>
          </div>
        </div>
        <button type="button" class="flex-shrink-0 w-12 h-12 rounded-full bg-violet-600 hover:bg-violet-500 flex items-center justify-center m-1" id="search-btn" aria-label="Search">
          <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
        </button>
      </div>

      <!-- Section: Popular [role] -->
      <section class="mb-10">
        <h2 class="text-xl font-bold text-slate-900 mb-4" id="section-popular-title">Popular influencers</h2>
        <div class="overflow-x-auto pb-2 -mx-1" id="section-popular">
          <div class="flex gap-4 min-w-max">
            <p class="text-slate-500 py-8">Loading…</p>
          </div>
        </div>
      </section>

      <!-- Section: Featured [role] -->
      <section>
        <h2 class="text-xl font-bold text-slate-900 mb-4" id="section-featured-title">Featured influencers</h2>
        <div class="overflow-x-auto pb-2 -mx-1" id="section-featured">
          <div class="flex gap-4 min-w-max">
            <p class="text-slate-500 py-8">Loading…</p>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    import { subscribeAuth, getCurrentUser } from '../lib/firebase/authState';
    import { signOut, updateMode } from '../lib/services/authService';
    import { getCreatorsByRole } from '../lib/services/creatorsService';
    import type { Role } from '../lib/types/role';
    import { SELLER_ROLES } from '../lib/types/role';
    import type { CreatorCard } from '../lib/services/creatorsService';

    function getInitials(displayName: string): string {
      return displayName
        ? displayName.split(/\s+/).map((w) => w[0]).slice(0, 2).join('').toUpperCase() || '?'
        : '?';
    }

    function renderCard(creator: CreatorCard): string {
      const initials = getInitials(creator.displayName);
      const roleLabel = creator.role.charAt(0).toUpperCase() + creator.role.slice(1);
      return `
        <a href="/seller/${creator.sellerCode}" class="flex-shrink-0 w-64 rounded-xl border border-slate-200 bg-white overflow-hidden shadow-sm hover:shadow-md hover:border-slate-300 transition-all block">
          <div class="aspect-[4/3] bg-slate-100 flex items-center justify-center">
            <span class="text-3xl font-semibold text-slate-400">${initials}</span>
          </div>
          <div class="p-3">
            <p class="font-medium text-slate-900 truncate">${creator.displayName}</p>
            <p class="text-sm text-slate-500">${roleLabel}</p>
          </div>
        </a>
      `;
    }

    function renderCards(container: HTMLElement, creators: CreatorCard[]) {
      if (creators.length === 0) {
        container.innerHTML = '<p class="text-slate-500 py-8">No creators yet.</p>';
        return;
      }
      container.innerHTML = `<div class="flex gap-4 min-w-max">${creators.map(renderCard).join('')}</div>`;
    }

    function setActiveTab(role: Role) {
      document.querySelectorAll('.discover-tab').forEach((el) => {
        const e = el as HTMLElement;
        if (e.dataset.roleTab === role) e.setAttribute('data-active', 'true');
        else e.removeAttribute('data-active');
      });
      const title = role.charAt(0).toUpperCase() + role.slice(1);
      (document.getElementById('section-popular-title') as HTMLElement).textContent = `Popular ${title}`;
      (document.getElementById('section-featured-title') as HTMLElement).textContent = `Featured ${title}`;
      (document.getElementById('search-what') as HTMLElement).textContent = title;
    }

    function showSignInToSeeCreators() {
      const popularEl = document.getElementById('section-popular');
      const featuredEl = document.getElementById('section-featured');
      if (!popularEl || !featuredEl) return;
      const msg = '<div class="flex gap-4 min-w-max"><p class="text-slate-500 py-8"><a href="/login" class="text-violet-600 hover:underline">Sign in</a> to see creators.</p></div>';
      popularEl.innerHTML = msg;
      featuredEl.innerHTML = msg;
    }

    async function loadSection(role: Role) {
      const popularEl = document.getElementById('section-popular');
      const featuredEl = document.getElementById('section-featured');
      if (!popularEl || !featuredEl) return;
      popularEl.innerHTML = '<div class="flex gap-4 min-w-max"><p class="text-slate-500 py-8">Loading…</p></div>';
      featuredEl.innerHTML = '<div class="flex gap-4 min-w-max"><p class="text-slate-500 py-8">Loading…</p></div>';
      try {
        const all = await getCreatorsByRole(role, { limit: 20 });
        const mid = Math.ceil(all.length / 2);
        renderCards(popularEl, all.slice(0, mid));
        renderCards(featuredEl, all.slice(mid));
      } catch (err) {
        console.error('[Discover] loadSection failed', err);
        renderCards(popularEl, []);
        renderCards(featuredEl, []);
      }
    }

    // Header nav: auth-aware; for sellers show mode toggle
    function renderHeaderNav(user: ReturnType<typeof getCurrentUser>) {
      const nav = document.getElementById('discover-header-nav');
      if (!nav) return;
      const loggedIn = !!user;
      if (loggedIn && user) {
        const isSeller = user.profile?.accountType === 'seller';
        const mode = user.profile?.mode ?? 'selling';
        let toggleHtml = '';
        if (isSeller) {
          toggleHtml = `
            <a href="/seller/setup" class="text-sm font-medium text-slate-600 hover:text-slate-900 px-3 py-2 rounded-lg hover:bg-slate-100">Seller profile</a>
            <span class="text-sm text-slate-500 mr-1">Mode:</span>
            <button type="button" id="discover-mode-toggle" class="text-sm font-medium px-3 py-1.5 rounded-lg ${mode === 'buying' ? 'bg-violet-100 text-violet-800' : 'bg-slate-100 text-slate-700'}">
              ${mode === 'buying' ? 'Buying' : 'Selling'}
            </button>
          `;
        }
        nav.innerHTML = `
          <a href="/discover" class="text-sm font-medium text-slate-900 px-3 py-2 rounded-lg bg-slate-100">Discover</a>
          <a href="/profile/me" class="text-sm font-medium text-slate-600 hover:text-slate-900 px-3 py-2 rounded-lg hover:bg-slate-100">My Profile</a>
          ${toggleHtml}
          <a href="/discover" class="text-sm font-medium text-slate-600 hover:text-slate-900 px-3 py-2 rounded-lg hover:bg-slate-100">My Bookings</a>
          <button type="button" id="discover-logout" class="text-sm font-medium text-slate-600 hover:text-slate-900 px-3 py-2 rounded-lg hover:bg-slate-100">Logout</button>
        `;
        document.getElementById('discover-logout')?.addEventListener('click', () => {
          signOut().then(() => { window.location.href = '/'; });
        });
        const modeToggle = document.getElementById('discover-mode-toggle');
        if (modeToggle && isSeller) {
          modeToggle.addEventListener('click', async () => {
            const next = mode === 'selling' ? 'buying' : 'selling';
            try {
              await updateMode(user.id, next);
              window.location.reload();
            } catch (e) {
              console.error(e);
            }
          });
        }
      } else {
        nav.innerHTML = `
          <a href="/register" class="text-sm font-medium text-slate-600 hover:text-slate-900 px-3 py-2 rounded-lg hover:bg-slate-100">Become a seller</a>
          <a href="/login" class="text-sm font-medium text-slate-600 hover:text-slate-900 px-3 py-2 rounded-lg hover:bg-slate-100">Sign in</a>
          <a href="/register" class="text-sm font-semibold text-white bg-violet-600 hover:bg-violet-500 px-4 py-2 rounded-lg">Register</a>
        `;
      }
    }

    let activeRole: Role = 'influencer';
    setActiveTab(activeRole);

    document.querySelectorAll('.discover-tab').forEach((btn) => {
      btn.addEventListener('click', () => {
        const role = (btn as HTMLElement).dataset.roleTab as Role;
        if (!role || !SELLER_ROLES.includes(role)) return;
        activeRole = role;
        setActiveTab(activeRole);
        if (getCurrentUser()) loadSection(activeRole);
        else showSignInToSeeCreators();
      });
    });

    subscribeAuth((user) => {
      renderHeaderNav(user);
      if (user) {
        loadSection(activeRole);
      } else {
        showSignInToSeeCreators();
      }
    });
    renderHeaderNav(getCurrentUser());
  </script>
</Layout>
