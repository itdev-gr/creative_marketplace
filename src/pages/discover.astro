---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Discover – Creative Marketplace">
  <div class="min-h-screen flex flex-col bg-slate-50">
    <!-- Header: nav filled by client for auth -->
    <header class="border-b border-slate-200/80 bg-white/80 backdrop-blur-sm sticky top-0 z-20">
      <div class="max-w-6xl mx-auto px-4 sm:px-6 h-16 flex items-center justify-between">
        <a href="/" class="text-lg font-semibold text-slate-800 tracking-tight hover:text-violet-600 transition-colors">
          Creative Marketplace
        </a>
        <nav id="discover-header-nav" class="flex items-center gap-3">
          <a href="/register" class="text-sm font-medium text-slate-600 hover:text-slate-900 px-3 py-2 rounded-lg hover:bg-slate-100">Become a seller</a>
          <a href="/login" class="text-sm font-medium text-slate-600 hover:text-slate-900 px-3 py-2 rounded-lg hover:bg-slate-100">Sign in</a>
          <a href="/register" class="text-sm font-semibold text-white bg-violet-600 hover:bg-violet-500 px-4 py-2 rounded-lg">Register</a>
        </nav>
      </div>
    </header>

    <main class="flex-1 max-w-6xl mx-auto w-full px-4 sm:px-6 py-6">
      <!-- Menu tabs (image 2 style) -->
      <nav class="flex items-center gap-8 border-b border-slate-200 pb-0 mb-6" aria-label="Categories">
        <button type="button" data-role-tab="influencer" data-active="true" class="discover-tab pt-4 pb-3 px-1 font-medium text-slate-600 border-b-2 border-transparent hover:text-slate-900 data-[active]:text-slate-900 data-[active]:border-violet-600">
          Influencers
        </button>
        <button type="button" data-role-tab="videographer" class="discover-tab pt-4 pb-3 px-1 font-medium text-slate-600 border-b-2 border-transparent hover:text-slate-900 data-[active]:text-slate-900 data-[active]:border-violet-600">
          Videographers
        </button>
        <button type="button" data-role-tab="editor" class="discover-tab pt-4 pb-3 px-1 font-medium text-slate-600 border-b-2 border-transparent hover:text-slate-900 data-[active]:text-slate-900 data-[active]:border-violet-600">
          Editors
        </button>
        <button type="button" data-role-tab="model" class="discover-tab pt-4 pb-3 px-1 font-medium text-slate-600 border-b-2 border-transparent hover:text-slate-900 data-[active]:text-slate-900 data-[active]:border-violet-600">
          Models
        </button>
      </nav>

      <!-- Search bar (rounded, 3 segments + button) -->
      <div class="flex items-center rounded-full border border-slate-200 bg-white shadow-sm overflow-hidden mb-8">
        <div class="flex-1 flex divide-x divide-slate-200">
          <div class="flex-1 min-w-0 py-3 px-4">
            <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide">What</p>
            <p class="text-sm text-slate-400 truncate" id="search-what">Category</p>
          </div>
          <div class="flex-1 min-w-0 py-3 px-4">
            <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide">When</p>
            <p class="text-sm text-slate-400 truncate" id="search-when">Booking date</p>
          </div>
          <div class="flex-1 min-w-0 py-3 px-4">
            <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide">Sort</p>
            <p class="text-sm text-slate-400 truncate" id="search-sort">Newest</p>
          </div>
        </div>
        <button type="button" class="flex-shrink-0 w-12 h-12 rounded-full bg-violet-600 hover:bg-violet-500 flex items-center justify-center m-1" id="search-btn" aria-label="Search">
          <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
        </button>
      </div>

      <!-- Section: Popular [role] -->
      <section class="mb-10">
        <h2 class="text-xl font-bold text-slate-900 mb-4" id="section-popular-title">Popular influencers</h2>
        <div class="overflow-x-auto pb-2 -mx-1" id="section-popular">
          <div class="flex gap-4 min-w-max">
            <p class="text-slate-500 py-8">Loading…</p>
          </div>
        </div>
      </section>

      <!-- Section: Featured [role] -->
      <section>
        <h2 class="text-xl font-bold text-slate-900 mb-4" id="section-featured-title">Featured influencers</h2>
        <div class="overflow-x-auto pb-2 -mx-1" id="section-featured">
          <div class="flex gap-4 min-w-max">
            <p class="text-slate-500 py-8">Loading…</p>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    import { subscribeAuth, getCurrentUser, isAuthReady } from '../lib/firebase/authState';
    import { signOut, updateMode } from '../lib/services/authService';
    import { getCreatorsByRole } from '../lib/services/creatorsService';
    import { getListingsBySeller } from '../lib/services/listingsService';
    import type { Role } from '../lib/types/role';
    import { SELLER_ROLES } from '../lib/types/role';
    import type { Listing } from '../lib/types/listing';

    interface ListingCard {
      listing: Listing;
      sellerCode: string;
      displayName: string;
    }

    function listingCreatedAt(listing: Listing): number {
      const ts = listing.createdAt;
      if (!ts) return 0;
      if (typeof (ts as { toDate?: () => Date }).toDate === 'function') return (ts as { toDate: () => Date }).toDate().getTime();
      if (typeof (ts as { seconds?: number }).seconds === 'number') return (ts as { seconds: number }).seconds * 1000;
      return 0;
    }

    function truncateDesc(desc: string | undefined, maxLen: number): string {
      if (!desc) return '';
      return desc.length <= maxLen ? desc : desc.slice(0, maxLen) + '…';
    }

    function renderListingCard(item: ListingCard): string {
      const titleEsc = item.listing.title.replace(/</g, '&lt;').replace(/>/g, '&gt;');
      const descEsc = truncateDesc(item.listing.description, 100).replace(/</g, '&lt;').replace(/>/g, '&gt;');
      const nameEsc = item.displayName.replace(/</g, '&lt;').replace(/>/g, '&gt;');
      return `
        <a href="/seller/${item.sellerCode}" class="flex-shrink-0 w-64 rounded-xl border border-slate-200 bg-white overflow-hidden shadow-sm hover:shadow-md hover:border-slate-300 transition-all block">
          <div class="p-4">
            <p class="font-medium text-slate-900 truncate">${titleEsc}</p>
            ${descEsc ? `<p class="text-sm text-slate-600 mt-1 line-clamp-2">${descEsc}</p>` : ''}
            <p class="text-xs text-slate-500 mt-2">by ${nameEsc}</p>
          </div>
        </a>
      `;
    }

    function renderListingCards(container: HTMLElement, items: ListingCard[]) {
      if (items.length === 0) {
        container.innerHTML = '<p class="text-slate-500 py-8">No services yet.</p>';
        return;
      }
      container.innerHTML = `<div class="flex gap-4 min-w-max">${items.map(renderListingCard).join('')}</div>`;
    }

    function setActiveTab(role: Role) {
      document.querySelectorAll('.discover-tab').forEach((el) => {
        const e = el as HTMLElement;
        if (e.dataset.roleTab === role) e.setAttribute('data-active', 'true');
        else e.removeAttribute('data-active');
      });
      const title = role.charAt(0).toUpperCase() + role.slice(1);
      (document.getElementById('section-popular-title') as HTMLElement).textContent = `Popular ${title}`;
      (document.getElementById('section-featured-title') as HTMLElement).textContent = `Featured ${title}`;
      (document.getElementById('search-what') as HTMLElement).textContent = title;
    }

    function showSignInToSeeCreators() {
      const popularEl = document.getElementById('section-popular');
      const featuredEl = document.getElementById('section-featured');
      if (!popularEl || !featuredEl) return;
      const msg = '<div class="flex gap-4 min-w-max"><p class="text-slate-500 py-8"><a href="/login" class="text-violet-600 hover:underline">Sign in</a> to see creators.</p></div>';
      popularEl.innerHTML = msg;
      featuredEl.innerHTML = msg;
    }

    function redirectIfSellerInSellingMode(user: ReturnType<typeof getCurrentUser>) {
      if (!user?.profile) return;
      if (user.profile.accountType === 'seller' && user.profile.mode === 'selling') {
        window.location.href = '/seller/dashboard';
      }
    }

    async function loadSection(role: Role) {
      const popularEl = document.getElementById('section-popular');
      const featuredEl = document.getElementById('section-featured');
      if (!popularEl || !featuredEl) return;
      popularEl.innerHTML = '<div class="flex gap-4 min-w-max"><p class="text-slate-500 py-8">Loading…</p></div>';
      featuredEl.innerHTML = '<div class="flex gap-4 min-w-max"><p class="text-slate-500 py-8">Loading…</p></div>';
      try {
        const creators = await getCreatorsByRole(role, { limit: 20 });
        const listingsPerCreator = await Promise.all(creators.map((c) => getListingsBySeller(c.id, role)));
        const listingCards: ListingCard[] = [];
        creators.forEach((creator, i) => {
          const list = listingsPerCreator[i] ?? [];
          list.forEach((listing) => {
            listingCards.push({ listing, sellerCode: creator.sellerCode, displayName: creator.displayName });
          });
        });
        listingCards.sort((a, b) => listingCreatedAt(b.listing) - listingCreatedAt(a.listing));
        const capped = listingCards.slice(0, 40);
        const mid = Math.ceil(capped.length / 2);
        renderListingCards(popularEl, capped.slice(0, mid));
        renderListingCards(featuredEl, capped.slice(mid));
      } catch (err) {
        console.error('[Discover] loadSection failed', err);
        renderListingCards(popularEl, []);
        renderListingCards(featuredEl, []);
      }
    }

    // Header nav: auth-aware; for sellers show mode toggle
    function renderHeaderNav(user: ReturnType<typeof getCurrentUser>) {
      const nav = document.getElementById('discover-header-nav');
      if (!nav) return;
      const loggedIn = !!user;
      if (loggedIn && user) {
        const isSeller = user.profile?.accountType === 'seller';
        const mode = user.profile?.mode ?? 'selling';
        const displayName = user.profile?.displayName ?? 'User';
        const initials = displayName.split(/\s+/).map((w) => w[0]).slice(0, 2).join('').toUpperCase() || '?';
        const modeLabel = isSeller ? (mode === 'buying' ? 'Buying' : 'Selling') : 'Buyer';
        let toggleHtml = '';
        if (isSeller) {
          toggleHtml = `
            <a href="/seller/setup" class="text-sm font-medium text-slate-600 hover:text-slate-900 px-3 py-2 rounded-lg hover:bg-slate-100">Seller profile</a>
            <span class="text-sm text-slate-500 mr-1">Mode:</span>
            <button type="button" id="discover-mode-toggle" class="text-sm font-medium px-3 py-1.5 rounded-lg ${mode === 'buying' ? 'bg-violet-100 text-violet-800' : 'bg-slate-100 text-slate-700'}">
              ${mode === 'buying' ? 'Buying' : 'Selling'}
            </button>
          `;
        }
        nav.innerHTML = `
          <a href="/discover" class="text-sm font-medium text-slate-900 px-3 py-2 rounded-lg bg-slate-100">Discover</a>
          <a href="/profile/me" class="text-sm font-medium text-slate-600 hover:text-slate-900 px-3 py-2 rounded-lg hover:bg-slate-100">My Profile</a>
          ${toggleHtml}
          <a href="/seller/dashboard" class="text-sm font-medium text-slate-600 hover:text-slate-900 px-3 py-2 rounded-lg hover:bg-slate-100">My Bookings</a>
          <div id="profile-menu-wrap" class="relative">
            <button type="button" id="profile-menu-trigger" class="flex items-center justify-center w-9 h-9 rounded-full bg-slate-200 text-slate-700 text-sm font-semibold hover:bg-slate-300 transition-colors" aria-label="Profile menu" aria-expanded="false" aria-haspopup="true">
              ${initials}
            </button>
            <div id="profile-menu-dropdown" class="absolute right-0 top-full mt-1.5 w-56 rounded-lg bg-slate-50 shadow-xl border border-slate-200 py-2 hidden z-30">
              <div class="px-4 py-3 flex items-center gap-3">
                <div class="flex-shrink-0 w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center text-sm font-semibold text-slate-700">${initials}</div>
                <div class="min-w-0">
                  <p class="font-semibold text-slate-900 truncate">${displayName}</p>
                  <p class="text-xs text-slate-500">${modeLabel}</p>
                </div>
              </div>
              <hr class="border-slate-200 my-2" />
              <a href="${isSeller ? '/seller/dashboard' : '/discover'}" class="profile-menu-item flex items-center gap-3 px-4 py-2.5 text-sm text-slate-700 hover:bg-slate-100 hover:text-slate-900">
                <svg class="w-4 h-4 text-slate-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>
                Dashboard
              </a>
              <a href="/profile/me" class="profile-menu-item flex items-center gap-3 px-4 py-2.5 text-sm text-slate-700 hover:bg-slate-100 hover:text-slate-900">
                <svg class="w-4 h-4 text-slate-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                Settings
              </a>
              <hr class="border-slate-600/80 my-2" />
              <button type="button" id="profile-menu-logout" class="profile-menu-item w-full flex items-center gap-3 px-4 py-2.5 text-sm text-slate-700 hover:bg-slate-100 hover:text-slate-900 text-left">
                <svg class="w-4 h-4 text-slate-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                Logout
              </button>
            </div>
          </div>
        `;
        const wrap = document.getElementById('profile-menu-wrap');
        const trigger = document.getElementById('profile-menu-trigger');
        const dropdown = document.getElementById('profile-menu-dropdown');
        const open = () => { dropdown?.classList.remove('hidden'); trigger?.setAttribute('aria-expanded', 'true'); };
        const close = () => { dropdown?.classList.add('hidden'); trigger?.setAttribute('aria-expanded', 'false'); };
        const toggle = () => { if (dropdown?.classList.contains('hidden')) open(); else close(); };
        trigger?.addEventListener('click', (e) => { e.stopPropagation(); toggle(); });
        document.getElementById('profile-menu-logout')?.addEventListener('click', () => {
          signOut().then(() => { window.location.href = '/'; });
        });
        document.addEventListener('click', (e) => {
          if (wrap && !wrap.contains(e.target as Node)) close();
        });
        const modeToggle = document.getElementById('discover-mode-toggle');
        if (modeToggle && isSeller) {
          modeToggle.addEventListener('click', async () => {
            const next = mode === 'selling' ? 'buying' : 'selling';
            try {
              await updateMode(user.id, next);
              window.location.reload();
            } catch (e) {
              console.error(e);
            }
          });
        }
      } else {
        nav.innerHTML = `
          <a href="/register" class="text-sm font-medium text-slate-600 hover:text-slate-900 px-3 py-2 rounded-lg hover:bg-slate-100">Become a seller</a>
          <a href="/login" class="text-sm font-medium text-slate-600 hover:text-slate-900 px-3 py-2 rounded-lg hover:bg-slate-100">Sign in</a>
          <a href="/register" class="text-sm font-semibold text-white bg-violet-600 hover:bg-violet-500 px-4 py-2 rounded-lg">Register</a>
        `;
      }
    }

    let activeRole: Role = 'influencer';
    setActiveTab(activeRole);

    document.querySelectorAll('.discover-tab').forEach((btn) => {
      btn.addEventListener('click', () => {
        const role = (btn as HTMLElement).dataset.roleTab as Role;
        if (!role || !SELLER_ROLES.includes(role)) return;
        activeRole = role;
        setActiveTab(activeRole);
        if (getCurrentUser()) loadSection(activeRole);
        else showSignInToSeeCreators();
      });
    });

    subscribeAuth((user) => {
      redirectIfSellerInSellingMode(user);
      if (user?.profile?.accountType === 'seller' && user.profile?.mode === 'selling') return;
      renderHeaderNav(user);
      if (user) {
        loadSection(activeRole);
      } else {
        console.log('[AuthSession] Discover: showing sign-in UI (user=null, authReady=' + isAuthReady() + ')');
        showSignInToSeeCreators();
      }
    });
    const currentUser = getCurrentUser();
    redirectIfSellerInSellingMode(currentUser);
    if (!(currentUser?.profile?.accountType === 'seller' && currentUser.profile?.mode === 'selling')) {
      if (!currentUser) {
        console.log('[AuthSession] Discover: showing sign-in UI (user=null, authReady=' + isAuthReady() + ') [initial]');
      }
      renderHeaderNav(currentUser);
    }
  </script>
</Layout>
