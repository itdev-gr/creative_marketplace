---
import Layout from '../../layouts/Layout.astro';
import { SELLER_ROLES } from '../../lib/types/role';
---

<Layout title="Setup service profile – Creative Marketplace">
  <main class="min-h-screen flex items-center justify-center p-6">
    <div class="w-full max-w-lg space-y-6">
      <h1 class="text-2xl font-bold text-center">Setup service profile</h1>
      <p class="text-sm text-gray-600 text-center">Add a profile for this service type. You'll appear on Discover once it's complete.</p>
      <form id="seller-setup-form" class="space-y-4">
        <div id="seller-role-field">
          <label for="seller-role" class="block text-sm font-medium text-gray-700">Service type</label>
          <select
            id="seller-role"
            name="sellerRole"
            required
            class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 text-gray-900 shadow-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"
          >
            {SELLER_ROLES.map((role) => (
              <option value={role}>{role.charAt(0).toUpperCase() + role.slice(1)}</option>
            ))}
          </select>
        </div>
        <div>
          <label for="seller-title" class="block text-sm font-medium text-gray-700">Title</label>
          <input
            type="text"
            id="seller-title"
            name="title"
            required
            class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 text-gray-900 shadow-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"
            placeholder="e.g. Wedding videography"
          />
        </div>
        <div>
          <label for="seller-bio" class="block text-sm font-medium text-gray-700">Description</label>
          <textarea
            id="seller-bio"
            name="bio"
            rows={3}
            class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 text-gray-900 shadow-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"
            placeholder="Describe your service..."
          />
        </div>
        <div>
          <label for="seller-charge" class="block text-sm font-medium text-gray-700">Charge</label>
          <input
            type="text"
            id="seller-charge"
            name="charge"
            class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 text-gray-900 shadow-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"
            placeholder="e.g. 50€/hour"
          />
        </div>
        <div>
          <label for="seller-equipment" class="block text-sm font-medium text-gray-700">Equipment</label>
          <textarea
            id="seller-equipment"
            name="equipment"
            rows={2}
            class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 text-gray-900 shadow-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"
            placeholder="List your equipment..."
          />
        </div>
        <div id="influencer-fields" class="space-y-4 hidden">
          <p class="text-sm font-medium text-gray-700">Social & presence (Influencer)</p>
          <div class="grid grid-cols-1 gap-2 sm:grid-cols-[1fr_auto]">
            <label for="seller-instagram" class="sm:col-span-2 text-xs font-medium text-gray-600">Instagram</label>
            <input type="url" id="seller-instagram" name="instagramUrl" placeholder="Profile URL or @handle" class="rounded-md border border-gray-300 px-3 py-2 text-gray-900 shadow-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500" />
            <input type="number" id="seller-instagram-followers" name="instagramFollowers" min="0" placeholder="Followers" class="rounded-md border border-gray-300 px-3 py-2 text-gray-900 shadow-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 w-28" />
          </div>
          <div class="grid grid-cols-1 gap-2 sm:grid-cols-[1fr_auto]">
            <label for="seller-facebook" class="sm:col-span-2 text-xs font-medium text-gray-600">Facebook</label>
            <input type="url" id="seller-facebook" name="facebookUrl" placeholder="Profile URL" class="rounded-md border border-gray-300 px-3 py-2 text-gray-900 shadow-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500" />
            <input type="number" id="seller-facebook-followers" name="facebookFollowers" min="0" placeholder="Followers" class="rounded-md border border-gray-300 px-3 py-2 text-gray-900 shadow-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 w-28" />
          </div>
          <div class="grid grid-cols-1 gap-2 sm:grid-cols-[1fr_auto]">
            <label for="seller-tiktok" class="sm:col-span-2 text-xs font-medium text-gray-600">TikTok</label>
            <input type="url" id="seller-tiktok" name="tiktokUrl" placeholder="Profile URL" class="rounded-md border border-gray-300 px-3 py-2 text-gray-900 shadow-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500" />
            <input type="number" id="seller-tiktok-followers" name="tiktokFollowers" min="0" placeholder="Followers" class="rounded-md border border-gray-300 px-3 py-2 text-gray-900 shadow-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 w-28" />
          </div>
          <div>
            <label for="seller-website" class="block text-xs font-medium text-gray-600">Website</label>
            <input type="url" id="seller-website" name="websiteUrl" placeholder="https://..." class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 text-gray-900 shadow-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500" />
          </div>
          <div>
            <label for="seller-niche" class="block text-xs font-medium text-gray-600">Niche</label>
            <input type="text" id="seller-niche" name="niche" placeholder="e.g. Fashion, Fitness, Travel" class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 text-gray-900 shadow-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500" />
          </div>
        </div>
        <div id="seller-setup-error" class="hidden text-sm text-red-600" role="alert"></div>
        <button
          type="submit"
          id="seller-setup-submit"
          class="w-full rounded-md bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-600 focus:ring-offset-2 disabled:opacity-50"
        >
          Save
        </button>
      </form>
    </div>
  </main>
  <script>
    import { subscribeAuth, getCurrentUser, isAuthReady } from '../../lib/firebase/authState';
    import { createOrUpdateServiceProfile, getServiceProfile } from '../../lib/services/serviceProfilesService';
    import { isRole } from '../../lib/types/role';

    const form = document.getElementById('seller-setup-form') as HTMLFormElement;
    const errorEl = document.getElementById('seller-setup-error') as HTMLDivElement;
    const submitBtn = document.getElementById('seller-setup-submit') as HTMLButtonElement;
    const roleSelect = form?.querySelector('[name="sellerRole"]') as HTMLSelectElement | null;
    const influencerFields = document.getElementById('influencer-fields') as HTMLDivElement | null;

    function toggleInfluencerFields() {
      if (!influencerFields || !roleSelect) return;
      if (roleSelect.value === 'influencer') {
        influencerFields.classList.remove('hidden');
      } else {
        influencerFields.classList.add('hidden');
      }
    }

    function getRoleFromUrl(): string | null {
      const params = typeof window !== 'undefined' ? new URLSearchParams(window.location.search) : null;
      return params?.get('role') ?? null;
    }

    function redirectIfNotSeller(): boolean {
      if (!isAuthReady()) return true;
      const user = getCurrentUser();
      if (!user) {
        console.log('[AuthSession] Redirecting to /login (reason: user null)');
        window.location.href = '/login';
        return false;
      }
      if (user.profile?.accountType !== 'seller') {
        window.location.href = '/discover';
        return false;
      }
      return true;
    }

    function applyRoleFromUrl() {
      const role = getRoleFromUrl();
      if (role && isRole(role) && roleSelect) {
        roleSelect.value = role;
        roleSelect.disabled = true;
      }
      toggleInfluencerFields();
    }

    roleSelect?.addEventListener('change', toggleInfluencerFields);

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!redirectIfNotSeller()) return;
      errorEl.classList.add('hidden');
      errorEl.textContent = '';
      submitBtn.disabled = true;
      const roleFromUrl = getRoleFromUrl();
      const roleRaw = roleFromUrl && isRole(roleFromUrl) ? roleFromUrl : (roleSelect?.value ?? '');
      if (!isRole(roleRaw)) {
        errorEl.textContent = 'Please choose a valid service type.';
        errorEl.classList.remove('hidden');
        submitBtn.disabled = false;
        return;
      }
      const title = (form.querySelector('[name="title"]') as HTMLInputElement)?.value?.trim();
      if (!title) {
        errorEl.textContent = 'Please enter a title.';
        errorEl.classList.remove('hidden');
        submitBtn.disabled = false;
        return;
      }
      const uid = getCurrentUser()?.id;
      if (!uid) {
        window.location.href = '/login';
        submitBtn.disabled = false;
        return;
      }
      const bio = (form.querySelector('[name="bio"]') as HTMLTextAreaElement)?.value?.trim() || undefined;
      const charge = (form.querySelector('[name="charge"]') as HTMLInputElement)?.value?.trim() || undefined;
      const equipment = (form.querySelector('[name="equipment"]') as HTMLTextAreaElement)?.value?.trim() || undefined;
      const parseNum = (el: HTMLInputElement | null): number | null => {
        if (!el?.value?.trim()) return null;
        const n = Number(el.value.trim());
        return Number.isFinite(n) ? n : null;
      };
      const influencerData = roleRaw === 'influencer' ? {
        instagramUrl: (form.querySelector('[name="instagramUrl"]') as HTMLInputElement)?.value?.trim() || undefined,
        instagramFollowers: parseNum(form.querySelector('[name="instagramFollowers"]') as HTMLInputElement),
        facebookUrl: (form.querySelector('[name="facebookUrl"]') as HTMLInputElement)?.value?.trim() || undefined,
        facebookFollowers: parseNum(form.querySelector('[name="facebookFollowers"]') as HTMLInputElement),
        tiktokUrl: (form.querySelector('[name="tiktokUrl"]') as HTMLInputElement)?.value?.trim() || undefined,
        tiktokFollowers: parseNum(form.querySelector('[name="tiktokFollowers"]') as HTMLInputElement),
        websiteUrl: (form.querySelector('[name="websiteUrl"]') as HTMLInputElement)?.value?.trim() || undefined,
        niche: (form.querySelector('[name="niche"]') as HTMLInputElement)?.value?.trim() || undefined,
      } : {};

      try {
        await createOrUpdateServiceProfile(uid, roleRaw, { title, bio, charge, equipment, ...influencerData });
        await new Promise((r) => setTimeout(r, 400));
        window.location.href = '/seller/services';
      } catch (err) {
        const msg = err instanceof Error ? err.message : 'Update failed.';
        errorEl.textContent = msg;
        errorEl.classList.remove('hidden');
      } finally {
        submitBtn.disabled = false;
      }
    });

    async function prefillForm() {
      const user = getCurrentUser();
      if (!user?.id || user.profile?.accountType !== 'seller') return;
      const role = getRoleFromUrl() ?? roleSelect?.value;
      if (!role || !isRole(role)) return;
      const existing = await getServiceProfile(user.id, role);
      if (!existing) return;
      const titleInput = form?.querySelector('[name="title"]') as HTMLInputElement | null;
      const bioInput = form?.querySelector('[name="bio"]') as HTMLTextAreaElement | null;
      const chargeInput = form?.querySelector('[name="charge"]') as HTMLInputElement | null;
      const equipmentInput = form?.querySelector('[name="equipment"]') as HTMLTextAreaElement | null;
      if (titleInput && existing.title) titleInput.value = existing.title;
      if (bioInput && existing.bio) bioInput.value = existing.bio;
      if (chargeInput && existing.charge) chargeInput.value = existing.charge;
      if (equipmentInput && existing.equipment) equipmentInput.value = existing.equipment;
      toggleInfluencerFields();
      if (role === 'influencer') {
        const instagramUrlEl = form?.querySelector('[name="instagramUrl"]') as HTMLInputElement | null;
        const instagramFollowersEl = form?.querySelector('[name="instagramFollowers"]') as HTMLInputElement | null;
        const facebookUrlEl = form?.querySelector('[name="facebookUrl"]') as HTMLInputElement | null;
        const facebookFollowersEl = form?.querySelector('[name="facebookFollowers"]') as HTMLInputElement | null;
        const tiktokUrlEl = form?.querySelector('[name="tiktokUrl"]') as HTMLInputElement | null;
        const tiktokFollowersEl = form?.querySelector('[name="tiktokFollowers"]') as HTMLInputElement | null;
        const websiteUrlEl = form?.querySelector('[name="websiteUrl"]') as HTMLInputElement | null;
        const nicheEl = form?.querySelector('[name="niche"]') as HTMLInputElement | null;
        if (instagramUrlEl && existing.instagramUrl) instagramUrlEl.value = existing.instagramUrl;
        if (instagramFollowersEl && existing.instagramFollowers != null) instagramFollowersEl.value = String(existing.instagramFollowers);
        if (facebookUrlEl && existing.facebookUrl) facebookUrlEl.value = existing.facebookUrl;
        if (facebookFollowersEl && existing.facebookFollowers != null) facebookFollowersEl.value = String(existing.facebookFollowers);
        if (tiktokUrlEl && existing.tiktokUrl) tiktokUrlEl.value = existing.tiktokUrl;
        if (tiktokFollowersEl && existing.tiktokFollowers != null) tiktokFollowersEl.value = String(existing.tiktokFollowers);
        if (websiteUrlEl && existing.websiteUrl) websiteUrlEl.value = existing.websiteUrl;
        if (nicheEl && existing.niche) nicheEl.value = existing.niche;
      }
    }

    function init() {
      if (!redirectIfNotSeller()) return;
      const role = getRoleFromUrl();
      if (!role && typeof window !== 'undefined') {
        window.location.href = '/seller/services';
        return;
      }
      applyRoleFromUrl();
      toggleInfluencerFields();
      prefillForm();
    }

    subscribeAuth(() => {
      if (!redirectIfNotSeller()) return;
      applyRoleFromUrl();
      prefillForm();
    });
    init();
  </script>
</Layout>
