---
interface Props {
  profileId: string;
}

const { profileId } = Astro.props;
---

<div id="book-now-mount" data-profile-id={profileId}>
  <!-- Client-hydrated: Book Now button and booking form -->
</div>

<script>
  import { canBook } from '../lib/utils/canBook';
  import { subscribeAuth, getCurrentUser } from '../lib/firebase/authState';
  import { getProfile } from '../lib/services/authService';
  import { createBooking } from '../lib/services/bookingService';

  const mount = document.getElementById('book-now-mount');
  if (!mount) throw new Error('BookNowButton: mount not found');

  const profileId = mount.dataset.profileId ?? '';

  function render(
    profile: { id: string; role: import('../lib/types/role').Role; displayName?: string } | null,
    currentUser: ReturnType<typeof getCurrentUser>,
    error: string | null,
    loading: boolean
  ) {
    mount.innerHTML = '';
    if (loading) {
      const p = document.createElement('p');
      p.className = 'text-sm text-gray-500';
      p.textContent = 'Loading…';
      mount.appendChild(p);
      return;
    }
    if (error) {
      const p = document.createElement('p');
      p.className = 'text-sm text-red-600';
      p.setAttribute('role', 'alert');
      p.textContent = error;
      mount.appendChild(p);
      return;
    }
    if (!profile) return;

    const info = document.createElement('p');
    info.className = 'text-sm text-gray-700 mb-2';
    info.textContent = `${profile.displayName || 'User'} · ${profile.role}`;
    mount.appendChild(info);

    const showButton =
      currentUser?.profile &&
      canBook(currentUser.profile.role, profile.role, currentUser.id, profile.id);
    if (!showButton) {
      const p = document.createElement('p');
      p.className = 'text-sm text-gray-500';
      p.innerHTML = currentUser
        ? 'You cannot book this profile.'
        : '<a href="/login" class="text-indigo-600 hover:underline">Sign in</a> to book.';
      mount.appendChild(p);
      return;
    }

    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className =
      'rounded-md bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-600 focus:ring-offset-2';
    btn.textContent = 'Book Now';
    btn.addEventListener('click', () => openBookingModal(profile.role));
    mount.appendChild(btn);
  }

  async function openBookingModal(profileRole: import('../lib/types/role').Role) {
    const currentUser = getCurrentUser();
    if (!currentUser?.profile) return;

    const dateStr = window.prompt('Enter booking date (YYYY-MM-DD):');
    if (!dateStr) return;
    const date = new Date(dateStr + 'T12:00:00');
    if (Number.isNaN(date.getTime())) {
      render(
        { id: profileId, role: profileRole },
        currentUser,
        'Invalid date.',
        false
      );
      return;
    }

    const container = document.createElement('div');
    container.className = 'mt-2 text-sm';
    container.textContent = 'Creating booking…';
    mount.appendChild(container);

    try {
      await createBooking(
        currentUser.id,
        currentUser.profile.role,
        profileId,
        profileRole,
        date
      );
      container.textContent = 'Booking requested.';
      container.classList.remove('text-red-600');
      container.classList.add('text-green-600');
    } catch (err) {
      const msg = err instanceof Error ? err.message : 'Booking failed.';
      container.textContent = msg;
      container.classList.add('text-red-600');
    }
  }

  let profile: Awaited<ReturnType<typeof getProfile>> = null;
  let currentUser: ReturnType<typeof getCurrentUser> = null;
  let error: string | null = null;

  render(null, null, null, true);

  (async () => {
    profile = await getProfile(profileId);
    if (!profile) error = 'Profile not found.';
    currentUser = getCurrentUser();
    render(profile, currentUser, error, false);
  })();

  subscribeAuth((user) => {
    currentUser = user;
    render(profile, currentUser, error, false);
  });
</script>
